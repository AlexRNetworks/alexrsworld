<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alexr Games</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* --- PS4 SYSTEM FONTS & VARS --- */
    :root {
        --ps-blue: #00439c;
        --ps-light-blue: #00a0e9; /* Default accent color */
        --text-white: #e3f2fd;
        --card-size: 130px;
        --card-selected: 180px;
        --anim-speed: 0.25s;
    }

    * { box-sizing: border-box; user-select: none; }

    body {
        margin: 0;
        padding: 0;
        background-color: #003791;
        background-image: 
            radial-gradient(circle at 50% 0%, rgba(255,255,255,0.1) 0%, transparent 60%),
            linear-gradient(110deg, #003791 0%, #005c9e 50%, #003791 100%);
        background-size: 200% 200%;
        color: white;
        font-family: "SST", "Segoe UI", sans-serif;
        height: 100vh;
        overflow: hidden;
        animation: bgFlow 15s ease infinite;
        background-position: 0% 50%;
        background-repeat: no-repeat;
    }

    /* Theme variants (backgrounds and accent tweaks) */
    body.theme-default {
        background-color: #003791;
        background-image: 
            radial-gradient(circle at 50% 0%, rgba(255,255,255,0.1) 0%, transparent 60%),
            linear-gradient(110deg, #003791 0%, #005c9e 50%, #003791 100%);
        --ps-light-blue: #00a0e9; /* Ensure default is set */
    }

    body.theme-dark {
        background-color: #050816;
        background-image: radial-gradient(circle at 0 0, #222 0%, transparent 55%),
                          radial-gradient(circle at 100% 100%, #111 0%, transparent 55%),
                          linear-gradient(135deg,#050816,#000000);
        --ps-light-blue: #999999;
    }

    /* MODIFIED: Red theme background update */
    body.theme-red {
        background-color: #3a0000 !important;
        background-image:
            radial-gradient(circle at 20% 0, rgba(255,80,80,0.25) 0%, transparent 55%),
            radial-gradient(circle at 80% 100%, rgba(180,0,0,0.35) 0%, transparent 55%),
            linear-gradient(135deg, #3a0000, #7a0000) !important;
        --ps-light-blue: #ff4d4d !important; /* Use red accent color */
    }
    body.theme-red .card {
        background: rgba(60,0,0,0.6) !important;
    }
    body.theme-red .card.active {
        box-shadow: 0 0 0 4px #ff4d4d, 0 10px 20px rgba(0,0,0,0.8) !important;
    }


    body.theme-blue-dark {
        background-color: #020b1a;
        background-image: linear-gradient(135deg,#020b1a,#012b45);
        --ps-light-blue: #44aaff;
    }
    
    /* MODIFIED: Define theme accent variable for use in library/slider */
    body.theme-hacker {
        background-color: #000000;
        background-image: radial-gradient(circle at 20% 0, rgba(0,255,0,0.25) 0%, transparent 55%),
                          radial-gradient(circle at 80% 100%, rgba(0,255,0,0.25) 0%, transparent 55%);
        color: #00ff88;
        --ps-light-blue: #00ff88; /* ACCENT COLOR FOR CATEGORY BUTTONS/SLIDER */
    }
    
    /* MODIFIED: Define theme accent variable for use in library/slider */
    body.theme-tokyo {
        background-color: #050016;
        background-image: radial-gradient(circle at 10% 0, rgba(255,0,128,0.35) 0%, transparent 55%),
                          radial-gradient(circle at 90% 100%, rgba(0,255,255,0.35) 0%, transparent 55%),
                          linear-gradient(135deg,#050016,#001133);
        color: #e3f2fd; /* Text color remains light */
        --ps-light-blue: #ff4aff; /* ACCENT COLOR FOR CATEGORY BUTTONS/SLIDER */
    }

    /* Custom uploaded background (covers themes if present) */
    body.has-custom-bg {
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;
        animation: none;
    }

    /* PS5-style game background */
    .game-bg-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0;
        transition: opacity 0.6s ease;
        pointer-events: none;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        filter: blur(20px) brightness(0.4);
        transform: scale(1.1);
    }

    body.ps5-bg-enabled .game-bg-overlay.active {
        opacity: 1;
    }

    @keyframes bgFlow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* --- TOP NAVIGATION BAR --- */
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 30px 60px;
        font-size: 1.5rem;
        opacity: 0.9;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .site-title {
        font-weight: 300;
        font-size: 1.8rem;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
    }
    
    .site-title img { 
        height: 30px; 
        margin-right: 10px; 
    }

    .clock-area {
        font-size: 1.2rem;
        font-weight: 300;
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    /* Social Media Icons */
    .social-icons a {
        color: inherit; /* Inherit color from body (e.g., #00ff88 for hacker) */
        transition: color 0.2s;
    }
    .social-icons a:hover {
        color: var(--ps-light-blue); /* Use accent color on hover */
    }
    .social-icons {
        display: flex;
        gap: 15px;
        font-size: 1.4rem;
        color: white; /* Default color */
    }
    body.theme-hacker .social-icons { color: #00ff88; }
    body.theme-tokyo .social-icons { color: #ff4aff; }
    body.theme-red .social-icons { color: var(--ps-light-blue); } /* Apply theme color */


    /* --- MAIN CAROUSEL AREA --- */
    .main-stage {
        margin-top: 40px;
        width: 100%;
        position: relative;
    }

    .carousel-container {
        display: flex;
        align-items: center;
        padding-left: 60px;
        gap: 15px;
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        will-change: transform;
    }

    .card {
        width: var(--card-size);
        height: var(--card-size);
        background: rgba(0,0,0,0.3);
        flex-shrink: 0;
        position: relative;
        transition: all var(--anim-speed) ease;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        overflow: visible;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        /* Drag-and-drop */
        touch-action: pan-y; /* Allow vertical scroll, but let JS handle horizontal drag */
    }
    
    /* NEW: Dragging state for cards */
    .card:not(.system-card) {
        /* Only game cards are draggable */
        cursor: grab;
    }

    .card.dragging {
        opacity: 0.5;
        border: 2px dashed var(--ps-light-blue);
        box-shadow: none;
        transform: translateY(0); /* Remove selection lift */
        cursor: grabbing !important;
    }


    body.theme-hacker .card {
        background: rgba(0,20,0,0.7);
    }
    body.theme-tokyo .card {
        background: rgba(10,0,30,0.7);
    }

    .card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.8;
        transition: opacity 0.2s;
        pointer-events: none; /* Ignore pointer events on img for better drag/touch */
    }

    /* System Cards (Settings, Favorites, Library) */
    .card.system-card {
        background: linear-gradient(135deg, #0b407a, #001f4d);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255,255,255,0.1);
        cursor: pointer; /* System cards are not draggable */
    }
    body.theme-hacker .card.system-card {
        background: linear-gradient(135deg,#004400,#001400);
        border: 1px solid rgba(0,255,136,0.3);
    }
    body.theme-tokyo .card.system-card {
        background: linear-gradient(135deg,#ff007a, #3b00b3);
        border: 1px solid rgba(255,74,255,0.3);
    }
    body.theme-red .card.system-card {
        background: linear-gradient(135deg,#7a0000, #3a0000);
        border: 1px solid rgba(255,77,77,0.3);
    }

    .card.system-card i { font-size: 3rem; color: white; opacity: 0.8; }
    body.theme-hacker .card.system-card i,
    body.theme-tokyo .card.system-card i,
    body.theme-red .card.system-card i { 
        color: inherit; /* Use themed color */
        opacity: 1;
    }


    /* --- SELECTED STATE --- */
    .card.active {
        width: var(--card-selected);
        height: var(--card-selected);
        transform: translateY(10px);
        background: rgba(255,255,255,0.1);
        box-shadow: 0 0 0 4px white, 0 10px 20px rgba(0,0,0,0.5);
        z-index: 10;
    }

    body.theme-hacker .card.active {
        box-shadow: 0 0 0 4px #00ff88, 0 10px 20px rgba(0,0,0,0.8);
    }
    body.theme-tokyo .card.active {
        box-shadow: 0 0 0 4px var(--ps-light-blue), 0 10px 20px rgba(0,0,0,0.8);
    }

    .card.active img { opacity: 1; }

    /* --- INFO AREA (Below Carousel) --- */
    .info-area {
        margin-top: 80px;
        padding-left: 60px;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
    }

    .info-area.visible {
        opacity: 1;
        transform: translateY(0);
    }
    
    /* NEW: Hide sub-content when system tile is selected */
    .sub-content.hidden {
        display: none !important;
    }

    .game-title {
        font-size: 2.2rem;
        font-weight: 300;
        margin-bottom: 5px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
    }

    .game-meta {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: rgba(255,255,255,0.8);
        margin-bottom: 25px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* --- SUB CONTENT ROW --- */
    .sub-content {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }

    .sub-tile {
        width: 300px;
        height: 160px;
        background: rgba(0,0,0,0.4);
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        padding: 15px;
        position: relative;
        overflow: hidden;
        border-radius: 4px;
    }
    .sub-tile img {
        position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; opacity: 0.5; z-index: 0;
    }
    .sub-tile div { z-index: 1; position: relative; text-shadow: 1px 1px 2px black; }
    .sub-head { font-weight: bold; font-size: 1.1rem; }
    .sub-desc { font-size: 0.8rem; color: #ccc; }

    #favoriteTile {
        cursor: pointer;
    }

    /* --- LIBRARY & SETTINGS OVERLAY (Grid / Tabs View) --- */
    .library-overlay {
        position: fixed;
        inset: 0;
        background: rgba(11, 23, 48, 0.98);
        z-index: 1000;
        display: none;
        flex-direction: column;
        padding: 40px 80px;
        overflow-y: auto;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    body.theme-hacker .library-overlay {
        background: rgba(0,0,0,0.96);
    }
    body.theme-tokyo .library-overlay {
        background: rgba(5,0,25,0.96);
    }
    body.theme-red .library-overlay {
        background: rgba(58,0,0,0.96);
    }

    .library-overlay.show { display: flex; opacity: 1; }

    .lib-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 20px;
    }
    .lib-title { font-size: 2rem; font-weight: 300; }
    .close-btn { 
        background: none; border: 1px solid white; color: white; 
        padding: 10px 20px; cursor: pointer; border-radius: 4px; font-size: 1rem;
        transition: background 0.2s;
    }
    .close-btn:hover { background: white; color: black; }

    /* New: Filter area styles */
    .lib-filters {
        margin-bottom: 30px;
    }

    .lib-search {
        width: 100%;
        padding: 15px;
        margin-bottom: 15px;
        font-size: 1.2rem;
        border: 2px solid rgba(255,255,255,0.5);
        background: rgba(0,0,0,0.2);
        color: white;
        border-radius: 4px;
        outline: none;
        transition: border-color 0.2s;
    }
    .lib-search:focus {
        border-color: var(--ps-light-blue);
    }

    .lib-categories {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .category-btn {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 8px 16px;
        cursor: pointer;
        border-radius: 20px;
        font-size: 0.9rem;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
    }

    .category-btn.active {
        background: var(--ps-light-blue); /* Uses theme accent color */
        border-color: var(--ps-light-blue); /* Uses theme accent color */
        font-weight: bold;
    }
    .category-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    /* End New: Filter area styles */


    .lib-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 25px;
    }

    .lib-card {
        aspect-ratio: 1/1;
        background: #222;
        border-radius: 4px;
        position: relative;
        cursor: pointer;
        transition: transform 0.2s;
        overflow: hidden;
    }
    body.theme-hacker .lib-card { background: #011 !box-shadow: none; }
    body.theme-tokyo .lib-card { background: #102; box-shadow: none; }
    body.theme-red .lib-card { background: #200; box-shadow: none; } /* Red theme adjustment */

    .lib-card:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 2;}
    .lib-card img { width: 100%; height: 100%; object-fit: cover; }
    .lib-card-title {
        position: absolute; bottom: 0; left: 0; right: 0;
        background: rgba(0,0,0,0.8); padding: 8px; font-size: 0.85rem;
        text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

/* Fullscreen iframe fix - REPLACED VERSION */
.game-modal {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
    background: black !important;
    z-index: 9999 !important;
    display: flex !important;
    flex-direction: column !important;
    border: none !important;
    box-sizing: border-box !important;
}

.game-modal > div:first-child {
    position: relative !important;
    height: 40px !important;
    flex-shrink: 0 !important;
    z-index: 10000 !important;
    background: #222 !important;
    display: flex !important;
    align-items: center !important;
    padding: 0 20px !important;
    justify-content: space-between !important;
    color: white !important;
    gap: 10px !important;
}
/* Ensure the bar background is themed or dark */
body.theme-hacker .game-modal > div:first-child { background: #000 !important; color: #00ff88 !important; }
body.theme-tokyo .game-modal > div:first-child { background: #111 !important; color: #ff4aff !important; }
body.theme-red .game-modal > div:first-child { background: #3a0000 !important; color: var(--ps-light-blue) !important; } /* Red theme fix */

.game-modal > div:last-child {
    position: relative !important;
    flex: 1 !important;
    width: 100% !important;
    height: calc(100vh - 40px) !important;
}

.game-modal iframe {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    border: none !important;
}

/* Updated styles for iframe buttons to inherit site colors/theme better */
.game-modal button,
.game-modal .close-btn {
    /* Use current color properties which change with the theme */
    background: rgba(255,255,255,0.2) !important;
    border: 1px solid currentColor !important; /* Uses the current text color */
    color: currentColor !important; /* Uses the current text color */
    padding: 4px 12px !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    font-size: 0.85rem !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: inline-block !important;
    z-index: 10001 !important;
}

.game-modal button:hover {
    background: white !important;
    color: black !important;
}

/* Fix hide bar button - ADD THIS */
.game-modal .top-bar {
    position: relative !important;
    z-index: 10000 !important;
    transition: opacity 0.2s ease !important;
}

.game-modal .show-bar-btn {
    position: absolute !important;
    top: 5px !important;
    left: 5px !important;
    z-index: 10001 !important;
    width: 36px !important;
    height: 36px !important;
    padding: 0 !important;
    border: 1px solid #666 !important;
    background: rgba(0,0,0,0.9) !important;
    color: white !important;
    border-radius: 6px !important;
    font-size: 1.2rem !important;
    font-weight: bold !important;
    cursor: pointer !important;
    display: none !important;
    line-height: 1 !important;
}

/* Targeting the specific element for display: none */
.game-modal > div:first-child[style*="display: none"] ~ div .show-bar-btn {
    display: block !important;
}


    /* Other Things tabs buttons row */
    .other-tabs {
        display:flex; gap:10px; margin-bottom:20px;
        flex-wrap: wrap;
    }

    .tab-btn {
        background: none;
        border: 1px solid white;
        color: white;
        padding: 8px 16px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: background 0.2s, color 0.2s;
    }

    .tab-btn.active,
    .tab-btn:hover {
        background: white;
        color: black;
    }
    
    /* NEW: Styling for settings input/select */
    .settings-group {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .settings-group:last-child {
        border-bottom: none;
    }

    .settings-group label {
        display: block;
        font-size: 0.9rem;
        color: #ccc;
        margin-bottom: 5px;
    }

    .settings-input,
    .settings-select {
        width: 100%;
        max-width: 400px;
        padding: 10px;
        font-size: 1rem;
        border: 2px solid rgba(255,255,255,0.5);
        background: rgba(0,0,0,0.2);
        color: white;
        border-radius: 4px;
        outline: none;
        transition: border-color 0.2s;
        box-sizing: border-box;
    }

    .settings-input:focus,
    .settings-select:focus {
        border-color: var(--ps-light-blue);
    }
    .settings-select option {
        background: #000;
        color: white;
    }
    /* END NEW: Styling for settings input/select */


    /* Upload input hidden; use label button */
    #bgUploadInput {
        display:none;
    }
    
    /* NEW CSS for Sound Toggle Switch */
    .sound-control {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 15px;
    }
    
    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }
    
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }
    
    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .slider {
        background-color: var(--ps-light-blue); /* Uses theme accent color */
    }
    
    input:focus + .slider {
        box-shadow: 0 0 1px var(--ps-light-blue);
    }
    
    input:checked + .slider:before {
        transform: translateX(26px);
    }
</style>
</head>
<body>
    <div class="game-bg-overlay" id="gameBgOverlay"></div>

    <div class="top-bar">
        <div class="site-title"><img src="/new logo.png" alt="Alexr Games Logo"> Alexr's Math World</div>
        <div class="clock-area">
            <div class="social-icons">
                <a href="https://youtube.com/yourchannel" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>
                <a href="https://discord.gg/yourserver" target="_blank" title="Discord"><i class="fab fa-discord"></i></a>
                <a href="https://tiktok.com/@youraccount" target="_blank" title="TikTok"><i class="fab fa-tiktok"></i></a>
                <a href="https://instagram.com/youraccount" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
            </div>
            <span id="clock">12:00</span>
        </div>
    </div>

    <div class="main-stage">
        <div class="carousel-container" id="carousel"></div>
    </div>

    <div class="info-area visible" id="infoArea">
        <div class="game-title" id="gameTitle">Game Title</div>
        <div class="game-meta">
            <span id="gameCat">Category</span> • 
            <span>Unblocked</span>
        </div>

        <div class="sub-content">
            <div class="sub-tile">
                <img src="" id="bgPreview1" style="background:#222">
                <div class="sub-head">Overview</div>
                <div class="sub-desc" id="overviewDesc">Game Info</div>
            </div>
            <div class="sub-tile" id="versionsTile">
                <img src="" id="bgPreview2" style="background:#333">
                <div class="sub-head" id="versionsHead">Other Versions</div>
                <div class="sub-desc" id="versionsDesc">No other versions</div>
            </div>
            <div class="sub-tile" id="favoriteTile" style="background: linear-gradient(135deg, #00439c, #00285e); align-items: center; justify-content: center;">
                <div id="favoriteLabel" style="font-size: 1.5rem; font-weight: bold;">Favorite this game</div>
                <div class="sub-desc" id="favoriteStatus">Click to add to favorites</div>
            </div>
        </div>
    </div>

    <div class="library-overlay" id="libraryOverlay">
        <div class="lib-header">
            <div class="lib-title" id="libraryTitle">Your Collection</div>
            <button class="close-btn" onclick="closeOverlay()">Close</button>
        </div>
        
        <div class="lib-filters">
            <input type="text" id="libSearchInput" class="lib-search" placeholder="Search games by title..." oninput="renderOverlayGrid()" list="game-suggestions">
            <datalist id="game-suggestions"></datalist>
            <div class="lib-categories" id="libCategories">
                </div>
        </div>
        <div class="lib-grid" id="libraryGrid"></div>
    </div>

    <div class="library-overlay" id="otherOverlay">
        <div class="lib-header">
            <div class="lib-title">Settings</div>
            <button class="close-btn" onclick="toggleOther(false)">Close</button>
        </div>

        <div class="other-tabs">
            <button class="tab-btn" id="tab_changelog" onclick="showOtherTab('changelog')">Changelog</button>
            <button class="tab-btn" id="tab_proxy" onclick="showOtherTab('proxy')">Proxy</button>
            <button class="tab-btn" id="tab_themes" onclick="showOtherTab('themes')">Themes</button>
            <button class="tab-btn" id="tab_sounds" onclick="showOtherTab('sounds')">Sounds</button>
            <button class="tab-btn" id="tab_cloaking" onclick="showOtherTab('cloaking')">Cloaking</button>
        </div>

        <div id="other_changelog">
            <p>v1.0 – Initial release.</p>
            <p>v1.1 – Added favorites, recent games, and themes.</p>
            <p>v1.2 – Added custom backgrounds, more themes, and in-game actions.</p>
            <p>v1.3 – Added PS5-style game background feature and dedicated Settings tile.</p>
            <p>v1.4 – Added search bar and categories to the Library ("All Games") view.</p>
            <p>v1.5 – Added PS4-style sound effects and ambience control.</p>
            <p>v1.6 – Added Suggest/Report system tiles, themed Library, and fixed game bar toggle.</p>
            <p>v1.7 – Removed text labels from system tiles for a cleaner look.</p>
            <p>v1.8 – **NEW:** Added Tab Cloaking and Drag-and-Drop game reordering.</p>
        </div>

        <div id="other_proxy" style="display:none;">
            <p>Proxy links or information go here.</p>
        </div>

        <div id="other_themes" style="display:none;">
            <div class="settings-group">
                <p>Select a theme:</p>
                <button class="close-btn" onclick="setTheme('default')">Default</button>
                <button class="close-btn" onclick="setTheme('dark')">Dark</button>
                <button class="close-btn" onclick="setTheme('red')">Red</button>
                <button class="close-btn" onclick="setTheme('blue-dark')">Blue Dark</button>
                <button class="close-btn" onclick="setTheme('hacker')">Hacker</button>
                <button class="close-btn" onclick="setTheme('tokyo')">Tokyo</button>
            </div>

            <div class="settings-group">
                <p>PS5-Style Game Backgrounds:</p>
                <button class="close-btn" id="ps5BgToggle" onclick="togglePS5Backgrounds()">Enable PS5 Backgrounds</button>
                <p style="font-size:0.85rem; color:#aaa; margin-top:8px;">Show selected game image as blurred background</p>
            </div>

            <div class="settings-group">
                <p>Custom background image:</p>
                <label class="close-btn" for="bgUploadInput">Upload Background</label>
                <input type="file" id="bgUploadInput" accept="image/*">
                <button class="close-btn" onclick="clearCustomBackground()">Clear Custom Background</button>
            </div>
        </div>
        
        <div id="other_sounds" style="display:none;">
            <div class="settings-group">
                <p>Toggle Sound Effects and Ambience:</p>
                <div class="sound-control">
                    <label for="soundToggle">Enable Sounds</label>
                    <label class="switch">
                        <input type="checkbox" id="soundToggle" onchange="toggleSoundEffects(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <p style="font-size:0.85rem; color:#aaa; margin-top:15px;">
                    Sound effects include card hovers, selection, and a menu background track.
                </p>
            </div>
            
            <div class="settings-group">
                <p>Ambience Volume:</p>
                <input type="range" id="ambienceVolume" min="0" max="1" step="0.1" value="0.5" oninput="setAmbienceVolume(this.value)" style="width: 100%; margin-top: 10px;">
            </div>
        </div>
        
        <div id="other_cloaking" style="display:none;">
            <div class="settings-group">
                <p>Select a preset cloak:</p>
                <select id="cloakPresetSelect" class="settings-select" onchange="applyCloakPreset(this.value)">
                    <option value="none">None (Default)</option>
                    <option value="drive">Google Drive</option>
                    <option value="wiki">Wikipedia</option>
                    <option value="classlink">ClassLink</option>
                    <option value="school">School Website</option>
                </select>
                <button class="close-btn" style="margin-top:10px;" onclick="applyCloakPreset('none')">Clear Cloak</button>
            </div>

            <div class="settings-group">
                <p>Customize Tab:</p>
                <label for="customTitleInput">Tab Title:</label>
                <input type="text" id="customTitleInput" class="settings-input" placeholder="e.g., My Homework" oninput="setCustomTitle(this.value)">
            </div>
            
            <div class="settings-group">
                <label for="customFaviconInput">Favicon URL:</label>
                <input type="text" id="customFaviconInput" class="settings-input" placeholder="e.g., https://example.com/favicon.ico" oninput="setCustomFavicon(this.value)">
                <p style="font-size:0.85rem; color:#aaa; margin-top:8px;">Enter a URL for a favicon image (e.g., a .ico or small .png).</p>
            </div>
            
            <button class="close-btn" onclick="saveCustomCloak()">Save Custom Cloak</button>
        </div>
        </div>
    
    <script type="application/json" id="games-data">
        [
            {"title": "Subway Surfers", "category": "Runner", "path": "/games/subway_surfers/", "iframe": true, "img": "img/subway.png", "description": "Run, dodge, and collect coins on the train tracks."},
            {"title": "Slope", "category": "Arcade", "path": "/games/slope/", "iframe": true, "img": "img/slope.png", "description": "Roll a ball down a treacherous, neon slope."},
            {"title": "Tunnel Rush", "category": "Arcade", "path": "/games/tunnel_rush/", "iframe": true, "img": "img/tunnel.png", "description": "Navigate a high-speed tunnel of obstacles."},
            {"title": "Retro Bowl", "category": "Sports", "path": "/games/retro_bowl/", "iframe": true, "img": "img/retro.png", "description": "Classic-style American football simulation."},
            {"title": "Minecraft", "category": "Sandbox", "path": "/games/minecraft/", "iframe": true, "img": "img/minecraft.png", "description": "Explore, mine resources, and build anything you can imagine."},
            {"title": "FNAF", "category": "Horror", "path": "/games/fnaf/", "iframe": true, "img": "img/fnaf.png", "description": "Survive the night at Freddy Fazbear's Pizza."},
            {"title": "Drift Hunters", "category": "Racing", "path": "/games/drift_hunters/", "iframe": true, "img": "img/drift.png", "description": "High-quality 3D drifting game."},
            {"title": "Basket Random", "category": "Sports", "path": "/games/basket_random/", "iframe": true, "img": "img/basket.png", "description": "Hilarious physics-based 2v2 basketball."},
            {"title": "2048", "category": "Puzzle", "path": "/games/2048/", "iframe": true, "img": "img/2048.png", "description": "Combine numbered tiles to reach the 2048 tile."},
            {"title": "Vex 6", "category": "Platformer", "path": "/games/vex6/", "iframe": true, "img": "img/vex6.png", "description": "The latest installment in the challenging stickman platformer series."}
        ]
    </script>


    <script>
        const carousel = document.getElementById('carousel');
        const infoArea = document.getElementById('infoArea');
        const libOverlay = document.getElementById('libraryOverlay');
        const libGrid = document.getElementById('libraryGrid');
        const libraryTitle = document.getElementById('libraryTitle');
        const otherOverlay = document.getElementById('otherOverlay');
        const libSearchInput = document.getElementById('libSearchInput');
        const libCategoriesDiv = document.getElementById('libCategories');
        const gameSuggestionsDatalist = document.getElementById('game-suggestions');
        const subContent = document.querySelector('.sub-content'); 

        let allGamesData = [];
        let displayList = [];
        let selectedIndex = 0;
        let isLibraryOpen = false;
        let isOtherOpen = false;
        let currentOverlayMode = 'library';
        let favoritesSet = new Set();
        let currentCategoryFilter = 'All';
        let areSoundsEnabled = false;
        
        // Drag-and-Drop state
        let dragSrcEl = null;
        let systemTileStart = 4; // Index of the first game tile
        let systemTileEnd = 1; // Number of non-game tiles at the end (Library)


        // System item definitions
        const settingsItem = {
            title: "Settings",
            category: "System",
            description: "Customize themes and manage backgrounds.",
            systemType: "settings",
            icon: "fa-cog"
        };

        const favoritesItem = {
            title: "Favorites",
            category: "Favorites",
            description: "Your favorite games.",
            systemType: "favorites",
            icon: "fa-heart"
        };
        
        // NEW SYSTEM TILES
        const suggestItem = {
            title: "Suggest Game",
            category: "System",
            description: "Suggest a game via Google Form.",
            systemType: "suggest",
            icon: "fa-lightbulb",
            path: "https://docs.google.com/forms/d/e/1FAIpQLScXQf_W-j9Fk1G4_r_oA9-3A0b4vG0eYt-n0O4/viewform?usp=sf_link" // Placeholder URL
        };
        
        const reportItem = {
            title: "Report Bug",
            category: "System",
            description: "Report a bug via Google Form.",
            systemType: "report",
            icon: "fa-bug",
            path: "https://docs.google.com/forms/d/e/1FAIpQLScXQf_W-j9Fk1G4_r_oA9-3A0b4vG0eYt-n0O4/viewform?usp=sf_link" // Placeholder URL
        };

        const libraryItem = {
            title: "Library",
            category: "Collection",
            description: "View all games in your collection.",
            systemType: "library",
            icon: "fa-th"
        };
        
        /* --- CLOAKING MANAGER --- */
        
        const defaultTitle = "Alexr Games";
        const defaultFavicon = 'new logo.png'; // Assuming this is the default favicon

        const cloakPresets = {
            none: { title: defaultTitle, favicon: defaultFavicon },
            drive: { title: "My Drive - Google Drive", favicon: "https://ssl.gstatic.com/images/branding/product/2x/drive_2020q4_48dp.png" },
            wiki: { title: "Wikipedia, the free encyclopedia", favicon: "https://en.wikipedia.org/static/favicon/wikipedia.ico" },
            classlink: { title: "ClassLink", favicon: "https://www.classlink.com/favicon.ico" },
            school: { title: "Student Portal | Home", favicon: "https://www.example.edu/favicon.ico" } // Placeholder for a school
        };

        function setFavicon(url) {
            let link = document.querySelector("link[rel~='icon']");
            if (!link) {
                link = document.createElement('link');
                link.rel = 'icon';
                document.head.appendChild(link);
            }
            // Use local default if 'none' or blank
            if (!url || url === defaultFavicon) {
                 link.href = defaultFavicon;
                 link.rel = 'icon'; // Keep rel as 'icon'
                 return;
            }

            link.href = url;
            link.rel = 'icon'; // Ensure it's correctly set as favicon
        }

        function setTitle(title) {
            document.title = title;
        }

        function loadCloak() {
            const savedTitle = localStorage.getItem('alexrGames_cloakTitle');
            const savedFavicon = localStorage.getItem('alexrGames_cloakFavicon');
            
            if (savedTitle && savedFavicon) {
                setTitle(savedTitle);
                setFavicon(savedFavicon);
            } else {
                setTitle(defaultTitle);
                setFavicon(defaultFavicon);
            }
            
            // Update inputs in settings
            const titleInput = document.getElementById('customTitleInput');
            const faviconInput = document.getElementById('customFaviconInput');
            const presetSelect = document.getElementById('cloakPresetSelect');

            if (titleInput) titleInput.value = savedTitle && savedTitle !== defaultTitle ? savedTitle : '';
            if (faviconInput) faviconInput.value = savedFavicon && savedFavicon !== defaultFavicon ? savedFavicon : '';
            if (presetSelect) presetSelect.value = 'none'; // Clear preset selection on load
        }

        function saveCloak(title, favicon) {
            if (title === defaultTitle && favicon === defaultFavicon) {
                localStorage.removeItem('alexrGames_cloakTitle');
                localStorage.removeItem('alexrGames_cloakFavicon');
            } else {
                localStorage.setItem('alexrGames_cloakTitle', title);
                localStorage.setItem('alexrGames_cloakFavicon', favicon);
            }
            setTitle(title);
            setFavicon(favicon);
        }

        function applyCloakPreset(preset) {
            const cloak = cloakPresets[preset] || cloakPresets['none'];
            saveCloak(cloak.title, cloak.favicon);
            
            // Also update custom inputs
            const titleInput = document.getElementById('customTitleInput');
            const faviconInput = document.getElementById('customFaviconInput');
            if (titleInput) titleInput.value = cloak.title !== defaultTitle ? cloak.title : '';
            if (faviconInput) faviconInput.value = cloak.favicon !== defaultFavicon ? cloak.favicon : '';
        }
        
        function setCustomTitle(title) {
            // Live update the title if it's not empty, but don't save to storage yet
            if(title) {
                document.title = title;
            } else if (!document.getElementById('customFaviconInput').value) {
                document.title = defaultTitle;
            }
        }
        
        function setCustomFavicon(url) {
            // Live update the favicon if it's a valid URL, but don't save to storage yet
            if(url.startsWith('http')) {
                setFavicon(url);
            } else if (!document.getElementById('customTitleInput').value) {
                setFavicon(defaultFavicon);
            }
        }
        
        function saveCustomCloak() {
            const titleInput = document.getElementById('customTitleInput');
            const faviconInput = document.getElementById('customFaviconInput');
            const presetSelect = document.getElementById('cloakPresetSelect');
            
            const title = titleInput.value.trim() || defaultTitle;
            const favicon = faviconInput.value.trim() || defaultFavicon;
            
            saveCloak(title, favicon);
            
            // Reset preset selector
            if (presetSelect) presetSelect.value = 'none';
        }
        
        /* --- END CLOAKING MANAGER --- */

        /* --- SOUND MANAGER --- */
        
        const ambience = new Audio('sounds/ambience.mp3');
        ambience.loop = true;
        ambience.volume = localStorage.getItem('alexrGames_ambience_volume') || 0.5;

        const soundEffects = {
            click: new Audio('sounds/click.mp3'),
            hover: new Audio('sounds/hover.mp3'),
            select: new Audio('sounds/select.mp3'),
        };
        
        function loadSoundSettings() {
            const saved = localStorage.getItem('alexrGames_sounds_enabled') === 'true';
            areSoundsEnabled = saved;
            
            const toggle = document.getElementById('soundToggle');
            if (toggle) toggle.checked = saved;
            
            const volumeInput = document.getElementById('ambienceVolume');
            if (volumeInput) volumeInput.value = ambience.volume;

            if (saved && !document.querySelector('.game-modal')) {
                playAmbience();
            }
        }
        
        function toggleSoundEffects(enabled) {
            areSoundsEnabled = enabled;
            localStorage.setItem('alexrGames_sounds_enabled', enabled);
            if (enabled) {
                playAmbience();
            } else {
                pauseAmbience();
            }
        }
        
        function setAmbienceVolume(volume) {
            ambience.volume = volume;
            localStorage.setItem('alexrGames_ambience_volume', volume);
        }

        function playSound(name) {
            if (!areSoundsEnabled) return;
            const audio = soundEffects[name];
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.warn("Audio playback failed:", e));
            }
        }
        
        function playAmbience() {
            if (areSoundsEnabled) {
                // Check if a game is open or an overlay is up before playing
                if (!document.querySelector('.game-modal') && !isLibraryOpen && !isOtherOpen) {
                    ambience.play().catch(e => console.warn("Ambience playback failed:", e));
                }
            }
        }
        
        function pauseAmbience() {
            ambience.pause();
        }
        /* --- END SOUND MANAGER --- */

        /* THEME + CUSTOM BACKGROUND */

        function togglePS5Backgrounds() {
            const isEnabled = document.body.classList.toggle('ps5-bg-enabled');
            localStorage.setItem('alexrGames_ps5bg', isEnabled ? 'true' : 'false');
            const btn = document.getElementById('ps5BgToggle');
            if (btn) {
                btn.textContent = isEnabled ? 'Disable PS5 Backgrounds' : 'Enable PS5 Backgrounds';
            }
            if (!isEnabled) {
                const overlay = document.getElementById('gameBgOverlay');
                if (overlay) overlay.classList.remove('active');
            } else {
                updateGameBackground(displayList[selectedIndex]);
            }
        }

        function loadPS5BackgroundSetting() {
            const saved = localStorage.getItem('alexrGames_ps5bg');
            const isEnabled = saved === 'true';
            if (isEnabled) {
                document.body.classList.add('ps5-bg-enabled');
            }
            const btn = document.getElementById('ps5BgToggle');
            if (btn) {
                btn.textContent = isEnabled ? 'Disable PS5 Backgrounds' : 'Enable PS5 Backgrounds';
            }
        }

        function updateGameBackground(game) {
            const overlay = document.getElementById('gameBgOverlay');
            if (!overlay) return;
            
            const isEnabled = document.body.classList.contains('ps5-bg-enabled');
            
            if (!isEnabled || !game || game.systemType || !game.img) {
                overlay.classList.remove('active');
                return;
            }
            
            overlay.style.backgroundImage = `url(${game.img})`;
            overlay.classList.add('active');
        }

        function applyTheme(themeName) {
            document.body.classList.remove('theme-default','theme-dark','theme-red','theme-blue-dark','theme-hacker','theme-tokyo');
            document.body.classList.add('theme-' + themeName);
        }

        function setTheme(themeName) {
            applyTheme(themeName);
            localStorage.setItem('alexrGames_theme', themeName);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('alexrGames_theme') || 'default';
            applyTheme(savedTheme);
            const bg = localStorage.getItem('alexrGames_bg');
            if (bg) {
                document.body.style.backgroundImage = `url(${bg})`;
                document.body.classList.add('has-custom-bg');
            }
        }

        function clearCustomBackground() {
            localStorage.removeItem('alexrGames_bg');
            document.body.classList.remove('has-custom-bg');
            document.body.style.backgroundImage = '';
            const savedTheme = localStorage.getItem('alexrGames_theme') || 'default';
            applyTheme(savedTheme);
        }

        const bgUploadInput = document.getElementById('bgUploadInput');
        if (bgUploadInput) {
            bgUploadInput.addEventListener('change', function() {
                const file = this.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataURL = e.target.result;
                    document.body.style.backgroundImage = `url(${dataURL})`;
                    document.body.classList.add('has-custom-bg');
                    localStorage.setItem('alexrGames_bg', dataURL);
                };
                reader.readAsDataURL(file);
            });
        }

        // Load favorites from localStorage
        function loadFavorites() {
            const saved = localStorage.getItem('alexrGames_favorites');
            if (saved) {
                try {
                    const arr = JSON.parse(saved);
                    favoritesSet = new Set(arr);
                } catch (e) {
                    favoritesSet = new Set();
                }
            }
        }

        function saveFavorites() {
            localStorage.setItem('alexrGames_favorites', JSON.stringify(Array.from(favoritesSet)));
        }

        // Load game data with localStorage override
        function loadGames() {
            loadFavorites();

            const saved = localStorage.getItem('alexrGames_allGamesData');
            if (saved) {
                try {
                    allGamesData = JSON.parse(saved);
                    buildLists();
                    return;
                } catch (e) {
                    console.warn('Bad saved data, falling back to default');
                }
            }

            // Using the embedded JSON as fallback/default source
            try {
                const embedded = JSON.parse(document.getElementById('games-data').textContent);
                allGamesData = embedded;
                buildLists();
            } catch(e) {
                console.error("Failed to load embedded game data:", e);
                allGamesData = [];
                buildLists();
            }
        }

        function buildLists() {
            const firstSix = allGamesData.slice(0, 6);
            
            // MODIFIED: Order system tiles as requested: [Suggest, Report, Favorites, Settings, ...Games, Library]
            displayList = [suggestItem, reportItem, favoritesItem, settingsItem, ...firstSix, libraryItem];
            
            // Adjust systemTileStart based on the current system cards (4 system cards before first game)
            systemTileStart = 4;
            
            initCarousel();
            initLibraryGrid();
        }

        function saveGamesOrder() {
            // Save only the *game* data, excluding system tiles
            const gameDataToSave = displayList.slice(systemTileStart, displayList.length - systemTileEnd)
                .map(item => ({
                    title: item.title,
                    category: item.category,
                    path: item.path,
                    iframe: item.iframe,
                    img: item.img,
                    description: item.description,
                    versions: item.versions // Preserve other game data
                }));
            localStorage.setItem('alexrGames_allGamesData', JSON.stringify(gameDataToSave));
            allGamesData = gameDataToSave; // Update the source of truth
        }

        function promoteToRecent(game) {
            // Find the index of the game in the full game list
            const gameIndex = allGamesData.findIndex(g => g.title === game.title);
            if (gameIndex > 0) {
                // Move to the beginning (most recent)
                const [movedGame] = allGamesData.splice(gameIndex, 1);
                allGamesData.unshift(movedGame);
                saveGamesOrder();
                buildLists();
                // index 0=Suggest, 1=Report, 2=Favorites, 3=Settings, 4=first game
                updateSelection(systemTileStart); 
            }
        }
        
        /* --- DRAG-AND-DROP HANDLERS --- */
        function handleDragStart(e) {
            if (e.target.classList.contains('system-card')) return; // Ignore system cards
            
            e.target.classList.add('dragging');
            dragSrcEl = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }

        function handleDragOver(e) {
            e.preventDefault(); 
            e.dataTransfer.dropEffect = 'move';
            
            const target = e.target.closest('.card:not(.system-card)');
            if (!target || target === dragSrcEl) return;
            
            // Simple visual feedback: indicate where the card will drop
            // Find current game card elements for comparison
            const cards = Array.from(carousel.querySelectorAll('.card:not(.system-card)'));
            const draggedIndex = cards.findIndex(c => c === dragSrcEl);
            const targetIndex = cards.findIndex(c => c === target);

            // Determine if dragging left or right over the midpoint of the target
            const targetRect = target.getBoundingClientRect();
            const midpoint = targetRect.left + (targetRect.width / 2);
            
            if (draggedIndex < targetIndex && e.clientX > midpoint) {
                // Dragging from left to right, drop after target
                target.style.marginLeft = '15px'; // Push target right
                target.style.marginRight = '0';
            } else if (draggedIndex > targetIndex && e.clientX < midpoint) {
                // Dragging from right to left, drop before target
                target.style.marginRight = '15px'; // Push target left
                target.style.marginLeft = '0';
            } else {
                 // Reset margins if not dropping immediately next to it
                target.style.marginLeft = '0';
                target.style.marginRight = '0';
            }
        }
        
        function handleDragLeave(e) {
            // Reset margin when leaving a card
            const target = e.target.closest('.card:not(.system-card)');
            if (target) {
                target.style.marginLeft = '0';
                target.style.marginRight = '0';
            }
        }

        function handleDrop(e) {
            e.stopPropagation();
            const targetCard = e.target.closest('.card:not(.system-card)');
            
            if (!targetCard || dragSrcEl === targetCard) {
                return false; 
            }
            
            // Get the indices of the games in the *displayList*
            const dragIndex = parseInt(dragSrcEl.dataset.index);
            const dropIndex = parseInt(targetCard.dataset.index);

            // 1. Update the underlying allGamesData array
            // Convert to indices relative to allGamesData (which starts after the 4 system tiles)
            const dragGameIndex = dragIndex - systemTileStart;
            const dropGameIndex = dropIndex - systemTileStart;

            const [draggedGameData] = allGamesData.splice(dragGameIndex, 1);
            allGamesData.splice(dropGameIndex, 0, draggedGameData);

            // 2. Persist the new order
            saveGamesOrder();

            // 3. Re-render the carousel and set selection
            buildLists();
            updateSelection(dropIndex); // Select the newly dropped card
            
            return false;
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            
            // Reset all card margins
            document.querySelectorAll('.card:not(.system-card)').forEach(card => {
                card.style.marginLeft = '0';
                card.style.marginRight = '0';
            });
            
            dragSrcEl = null;
        }
        /* --- END DRAG-AND-DROP HANDLERS --- */


        function initCarousel() {
            carousel.innerHTML = '';
            
            displayList.forEach((game, index) => {
                const card = document.createElement('div');
                card.className = `card ${game.systemType ? 'system-card' : ''}`;
                card.dataset.index = index;
                
                if (game.systemType) {
                    card.innerHTML = `<i class="fas ${game.icon}"></i>`;
                    card.style.justifyContent = 'center';
                    card.style.alignItems = 'center';
                    // System cards are not draggable
                } else {
                    const img = document.createElement('img');
                    img.src = game.img || '';
                    img.onerror = function() { this.style.display='none'; card.style.background='#333'; };
                    card.appendChild(img);
                    
                    // Game cards are draggable
                    card.setAttribute('draggable', true);
                    card.addEventListener('dragstart', handleDragStart);
                    card.addEventListener('dragover', handleDragOver);
                    card.addEventListener('dragleave', handleDragLeave);
                    card.addEventListener('drop', handleDrop);
                    card.addEventListener('dragend', handleDragEnd);
                }
                
                card.addEventListener('click', () => {
                    if(selectedIndex === index) activateItem(index);
                    else updateSelection(index);
                });
                
                // Add hover sound listener for non-touch devices
                card.addEventListener('mouseover', () => {
                    if (!card.classList.contains('active')) {
                         playSound('hover');
                    }
                });

                carousel.appendChild(card);
            });

            // Default to first game if exists (index 4 in new layout)
            updateSelection(displayList.findIndex(g => !g.systemType) || 0); 
        }

        function getUniqueCategories() {
            const categories = allGamesData.map(game => game.category).filter(Boolean);
            return ['All', ...new Set(categories)];
        }
        
        function renderSearchSuggestions() {
            gameSuggestionsDatalist.innerHTML = '';
            allGamesData.forEach(game => {
                const option = document.createElement('option');
                option.value = game.title;
                gameSuggestionsDatalist.appendChild(option);
            });
        }

        function renderCategoryButtons() {
            libCategoriesDiv.innerHTML = '';
            const categories = getUniqueCategories();

            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.textContent = category;
                button.dataset.category = category;

                if (category === currentCategoryFilter) {
                    button.classList.add('active');
                }

                button.onclick = () => {
                    currentCategoryFilter = category;
                    renderCategoryButtons();
                    renderOverlayGrid();
                };

                libCategoriesDiv.appendChild(button);
            });
        }

        function initLibraryGrid() {
            renderSearchSuggestions();
            renderCategoryButtons();
            renderOverlayGrid();
        }

        function renderOverlayGrid() {
            libGrid.innerHTML = '';
            let gamesToShow = [];

            if (currentOverlayMode === 'library') {
                libraryTitle.textContent = 'All Games';
                gamesToShow = allGamesData;
                
                // Filtering logic
                const searchTerm = libSearchInput.value.toLowerCase().trim();
                
                gamesToShow = gamesToShow.filter(game => {
                    const matchesSearch = !searchTerm || game.title.toLowerCase().includes(searchTerm);
                    const matchesCategory = currentCategoryFilter === 'All' || game.category === currentCategoryFilter;
                    return matchesSearch && matchesCategory;
                });

            } else {
                libraryTitle.textContent = 'Your Favorites';
                gamesToShow = allGamesData.filter(g => favoritesSet.has(g.title));
            }

            gamesToShow.forEach((game) => {
                const card = document.createElement('div');
                card.className = 'lib-card';
                card.innerHTML = `
                    <img src="${game.img || ''}" onerror="this.style.display='none'">
                    <div class="lib-card-title">${game.title}</div>
                `;
                card.onclick = () => {
                    playSound('select');
                    toggleOverlay(false);
                    launchGame(game);
                };
                libGrid.appendChild(card);
            });
        }

        function updateSelection(index) {
            if(isLibraryOpen || isOtherOpen) return;
            if(index < 0) index = 0;
            if(index >= displayList.length) index = displayList.length - 1;
            
            selectedIndex = index;

            const cards = document.querySelectorAll('.card');
            cards.forEach(c => c.classList.remove('active'));
            if (cards[index]) cards[index].classList.add('active');

            const gap = 15;
            let offset = 0;
            
            // Calculate the position of the selected card
            let activeCardPosition = 0;
            for(let i = 0; i < index; i++) {
                const cardElement = cards[i];
                const cardWidth = cardElement.classList.contains('active') ? 180 : 130;
                activeCardPosition += cardWidth + gap + (parseFloat(cardElement.style.marginLeft) || 0) + (parseFloat(cardElement.style.marginRight) || 0);
            }
            
            // Calculate the required translation to center the selected card
            // We want to bring the left edge of the selected card to 60px from the left,
            // minus the drag-and-drop margins that might be temporarily applied.
            const targetOffset = activeCardPosition - 0; 
            offset = Math.max(0, targetOffset);
            
            carousel.style.transform = `translateX(-${offset}px)`;


            const g = displayList[index];
            document.getElementById('gameTitle').innerText = g.title || '';
            document.getElementById('gameCat').innerText = g.category || 'Game';
            document.getElementById('overviewDesc').innerText = g.description || 'Game Info';

            const bg1 = document.getElementById('bgPreview1');
            const bg2 = document.getElementById('bgPreview2');
            
            if(g.img) {
                bg1.src = g.img; bg2.src = g.img;
                bg1.style.filter = "grayscale(100%) blur(2px)";
                bg2.style.filter = "sepia(50%)";
            } else {
                bg1.src = ""; bg2.src = "";
            }

            // NEW FIX: Hide sub-content area for system tiles
            if (g.systemType) {
                subContent.classList.add('hidden');
                document.getElementById('gameTitle').innerText = g.title;
                document.getElementById('gameCat').innerText = g.category;
            } else {
                subContent.classList.remove('hidden');
            }

            updateFavoriteTile(g);
            updateVersionsTile(g);
            updateGameBackground(g); 

            infoArea.classList.remove('visible');
            setTimeout(() => infoArea.classList.add('visible'), 50);
        }

        function activateItem(index) {
            playSound('select');
            const item = displayList[index];

            if (item.systemType === 'library') {
                currentOverlayMode = 'library';
                currentCategoryFilter = 'All';
                libSearchInput.value = '';
                renderCategoryButtons();
                renderOverlayGrid();
                toggleOverlay(true);
            } else if (item.systemType === 'favorites') {
                currentOverlayMode = 'favorites';
                renderOverlayGrid();
                toggleOverlay(true);
            } else if (item.systemType === 'settings') {
                // Default to 'themes' tab when opening settings
                showOtherTab('themes'); 
                toggleOther(true);
            } else if (item.systemType === 'suggest' || item.systemType === 'report') {
                 window.open(item.path, '_blank');
            } else {
                launchGame(item);
            }
        }

        function toggleOverlay(show) {
            isLibraryOpen = show;
            if(show) {
                libOverlay.classList.add('show');
                libOverlay.style.opacity = '0';
                setTimeout(()=>libOverlay.style.opacity='1', 10);
            } else {
                libOverlay.style.opacity = '0';
                setTimeout(()=>libOverlay.classList.remove('show'), 300);
                // Resume ambience if returning to home menu (no other overlay and no game)
                if (!isOtherOpen && !document.querySelector('.game-modal')) {
                    playAmbience();
                }
            }
        }
        
        function closeOverlay() {
            playSound('click');
            toggleOverlay(false);
        }

        function toggleOther(show) {
            isOtherOpen = show;
            if (show) {
                otherOverlay.classList.add('show');
                otherOverlay.style.opacity = '0';
                setTimeout(() => otherOverlay.style.opacity = '1', 10);
            } else {
                playSound('click');
                otherOverlay.style.opacity = '0';
                setTimeout(() => otherOverlay.classList.remove('show'), 300);
                // Resume ambience if returning to home menu (no other overlay and no game)
                if (!isLibraryOpen && !document.querySelector('.game-modal')) {
                    playAmbience();
                }
            }
        }

        function showOtherTab(tab) {
            const tabs = ['changelog','proxy','themes', 'sounds', 'cloaking'];
            tabs.forEach(t => {
                document.getElementById('other_' + t).style.display = (t === tab) ? 'block' : 'none';
                const btn = document.getElementById('tab_' + t);
                if (btn) {
                    if (t === tab) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });
            
            // Re-load cloaking settings when opening its tab
            if (tab === 'cloaking') {
                loadCloak(); 
            }
        }

        function launchGame(game) {
            pauseAmbience(); 

            const modal = document.createElement('div');
           modal.className = 'game-modal'; 

            // --- 1. Top Bar Setup (Common to both) ---
            const bar = document.createElement('div');
            Object.assign(bar.style, {
                height: '40px', background: '#222', display: 'flex',
                alignItems: 'center', padding: '0 20px',
                justifyContent: 'space-between', color:'white', gap:'10px'
            });

            // Apply theme colors to the bar explicitly
            const currentBodyTheme = document.body.className.match(/theme-(\w+)/)?.[1] || 'default';
            if (currentBodyTheme === 'hacker') {
                Object.assign(bar.style, { background: '#000', color: '#00ff88' });
            } else if (currentBodyTheme === 'tokyo') {
                Object.assign(bar.style, { background: '#111', color: '#ff4aff' });
            } else if (currentBodyTheme === 'red') {
                // Red theme fix using CSS variable
                const redAccent = getComputedStyle(document.body).getPropertyValue('--ps-light-blue');
                Object.assign(bar.style, { background: '#3a0000', color: redAccent });
            }

            const leftSpan = document.createElement('span');
            leftSpan.textContent = game.title;

            const controls = document.createElement('div');
            controls.style.display = 'flex';
            controls.style.gap = '8px';

            // --- 2. Button Handlers (Common to both) ---
            
            // Reusable logic for opening in about:blank
            const openAboutBlank = () => {
                const w = window.open('about:blank', '_blank');
                if (w && w.document) {
                    const iframe = w.document.createElement('iframe');
                    iframe.style.border = 'none';
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.src = game.path;
                    w.document.body.style.margin = '0';
                    w.document.body.appendChild(iframe);
                }
            };

            const btnAboutBlank = document.createElement('button');
            btnAboutBlank.textContent = 'Open in about:blank';
            btnAboutBlank.className = 'close-btn';
            btnAboutBlank.onclick = openAboutBlank;

            const btnDownload = document.createElement('button');
            btnDownload.textContent = 'Download';
            btnDownload.className = 'close-btn';
            btnDownload.onclick = () => {
                const a = document.createElement('a');
                a.href = game.path;
                a.download = '';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const btnFav = document.createElement('button');
            btnFav.textContent = favoritesSet.has(game.title) ? 'Unfavorite' : 'Favorite';
            btnFav.className = 'close-btn';
            btnFav.onclick = () => {
                if (favoritesSet.has(game.title)) {
                    favoritesSet.delete(game.title);
                    btnFav.textContent = 'Favorite';
                } else {
                    favoritesSet.add(game.title);
                    btnFav.textContent = 'Unfavorite';
                }
                saveFavorites();
                updateFavoriteTile(game);
            };

            const btnHide = document.createElement('button');
            btnHide.textContent = 'Hide bar';
            btnHide.className = 'close-btn';

            const btnClose = document.createElement('button');
            btnClose.textContent = '✕ Close';
            btnClose.className = 'close-btn';
            btnClose.onclick = () => {
                playSound('click');
                document.body.removeChild(modal);
                // Only resume ambience if no system overlay is open
                if (!isLibraryOpen && !isOtherOpen) {
                    playAmbience();
                }
            };
            
            // Assemble controls
            controls.appendChild(btnAboutBlank);
            controls.appendChild(btnDownload);
            controls.appendChild(btnFav);
            controls.appendChild(btnHide);
            controls.appendChild(btnClose);

            bar.appendChild(leftSpan);
            bar.appendChild(controls);

            // --- 3. Content Area Setup (Custom per iframe status) ---
            const frameWrapper = document.createElement('div');
            frameWrapper.style.position = 'relative';
            frameWrapper.style.flex = '1';
            
            const showBarBtn = document.createElement('button');
            showBarBtn.textContent = '≡';
            showBarBtn.className = 'show-bar-btn';
            
            btnHide.onclick = () => {
                bar.style.display = 'none';
                showBarBtn.style.display = 'block';
            };
            showBarBtn.onclick = () => {
                bar.style.display = 'flex';
                showBarBtn.style.display = 'none';
            };


            if (game.iframe) {
                // Content: Game iframe
                const frame = document.createElement('iframe');
                frame.src = game.path;
                frame.style.flex = 1;
                frame.style.border = 'none';
                
                frameWrapper.appendChild(frame);
                frameWrapper.appendChild(showBarBtn);

            } else {
                // Content: Custom message for unsupported game (User Request)
                frameWrapper.style.display = 'flex';
                frameWrapper.style.flexDirection = 'column';
                frameWrapper.style.justifyContent = 'center';
                frameWrapper.style.alignItems = 'center';
                frameWrapper.style.textAlign = 'center';
                frameWrapper.style.background = '#000';
                
                const messageDiv = document.createElement('div');
                messageDiv.style.padding = '50px';
                messageDiv.style.maxWidth = '80%';
                
                const messageP = document.createElement('p');
                messageP.textContent = "Due to issues, this game is not supported here.";
                messageP.style.fontSize = '1.8rem';
                messageP.style.color = 'white';
                messageP.style.marginBottom = '0.5rem';

                const instructionsP = document.createElement('p');
                instructionsP.textContent = "Click Open in About:blank to proceed.";
                instructionsP.style.fontSize = '1.2rem';
                instructionsP.style.color = '#ccc';
                instructionsP.style.marginTop = '0';
                
                // Use a styled button for the About:blank link
                const bigAboutBlankBtn = btnAboutBlank.cloneNode(true);
                bigAboutBlankBtn.textContent = 'Open in About:blank';
                bigAboutBlankBtn.style.marginTop = '20px';
                bigAboutBlankBtn.style.padding = '10px 30px';
                bigAboutBlankBtn.style.fontSize = '1.1rem';
                bigAboutBlankBtn.onclick = openAboutBlank; // Re-wire handler
                
                messageDiv.appendChild(messageP);
                messageDiv.appendChild(instructionsP);
                messageDiv.appendChild(bigAboutBlankBtn);
                
                frameWrapper.appendChild(messageDiv);
            }

            // --- 4. Final Assembly & Launch (Common to both) ---
            modal.appendChild(bar);
            modal.appendChild(frameWrapper);
            document.body.appendChild(modal);
            promoteToRecent(game);
        }
        function updateFavoriteTile(game) {
            const tile = document.getElementById('favoriteTile');
            const label = document.getElementById('favoriteLabel');
            const status = document.getElementById('favoriteStatus');

            if (!game || game.systemType) {
                // Should not happen as sub-content is hidden, but for safety:
                tile.style.background = 'linear-gradient(135deg, #555, #333)';
                label.textContent = "Favorite this game";
                status.textContent = "Unavailable for system tiles";
                tile.onclick = null;
                return;
            }

            const isFav = favoritesSet.has(game.title);

            if (isFav) {
                tile.style.background = 'linear-gradient(135deg, #00c853, #64dd17)';
                label.textContent = "Favorited";
                status.textContent = "Click to remove from favorites";
            } else {
                tile.style.background = 'linear-gradient(135deg, #00439c, #00285e)';
                label.textContent = "Favorite this game";
                status.textContent = "Click to add to favorites";
            }

            tile.onclick = () => {
                if (favoritesSet.has(game.title)) {
                    favoritesSet.delete(game.title);
                } else {
                    favoritesSet.add(game.title);
                }
                saveFavorites();
                updateFavoriteTile(game);
            };
        }

        function updateVersionsTile(game) {
            const head = document.getElementById('versionsHead');
            const desc = document.getElementById('versionsDesc');
            const tile = document.getElementById('versionsTile');

            if (!game || game.systemType) {
                head.textContent = "Other Versions";
                desc.textContent = "Not available";
                tile.style.opacity = '0.5';
                tile.style.cursor = 'default';
                tile.onclick = null;
                return;
            }

            const versions = game.versions || [];

            if (versions.length > 0) {
                head.textContent = "Other Versions";
                desc.textContent = versions.length + " available version(s)";
                tile.style.opacity = '1';
                tile.style.cursor = 'pointer';

                tile.onclick = () => {
                    const choice = prompt(
                        "Other versions:\n" + versions.map((v, i) => (i + 1) + ". " + v).join("\n") +
                        "\nEnter number to launch:"
                    );
                    const idx = parseInt(choice, 10) - 1;
                    if (!isNaN(idx) && versions[idx]) {
                        window.open(versions[idx], '_blank');
                    }
                };
            } else {
                head.textContent = "Other Versions";
                desc.textContent = "No other versions";
                tile.style.opacity = '0.5';
                tile.style.cursor = 'default';
                tile.onclick = null;
            }
        }

        // Clock
        setInterval(() => {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock').innerText = `${h}:${m}`;
        }, 1000);

        // Inputs
        window.addEventListener('keydown', (e) => {
            if (isLibraryOpen || isOtherOpen) {
                if(e.key === 'Escape') {
                    if(isLibraryOpen) {
                        libSearchInput.value = '';
                        currentCategoryFilter = 'All';
                        renderCategoryButtons();
                        renderOverlayGrid();
                        closeOverlay();
                    } else if (isOtherOpen) {
                        toggleOther(false);
                    }
                }
                return;
            }
            
            // Do not allow movement while dragging a card
            if (dragSrcEl) return;
            
            const oldIndex = selectedIndex;

            if(e.key === 'ArrowRight') updateSelection(selectedIndex + 1);
            if(e.key === 'ArrowLeft') updateSelection(selectedIndex - 1);
            
            if ((e.key === 'ArrowRight' || e.key === 'ArrowLeft') && selectedIndex !== oldIndex) {
                playSound('hover');
            }

            if(e.key === 'Enter') activateItem(selectedIndex);
        });

        // Initialize
        loadTheme();
        loadGames();
        loadPS5BackgroundSetting();
        loadSoundSettings();
        loadCloak();
    </script>

<style>
/* RED THEME OVERRIDES (match other themes) */
/* The main theme-red block above handles most of this now, but keeping the background override for safety/clarity */
body.theme-red {
    background-color: #3a0000 !important;
    background-image:
        radial-gradient(circle at 20% 0, rgba(255,80,80,0.25) 0%, transparent 55%),
        radial-gradient(circle at 80% 100%, rgba(180,0,0,0.35) 0%, transparent 55%),
        linear-gradient(135deg, #3a0000, #7a0000) !important;
    --ps-light-blue: #ff4d4d !important;
}
</style>

</body>
</html>